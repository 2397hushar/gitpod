# Copyright (c) 2022 Gitpod GmbH. All rights reserved.
# Licensed under the GNU Affero General Public License (AGPL).
# See License-AGPL.txt in the project root for license information.

- id: tailscale
  name: "Tailscale"
  attributes:
    - AUTH_KEY
  envVars:
  tasks:
    - tailscaled: |-
        curl -fsSL https://tailscale.com/install.sh | sh
        gp sync-done tailscale-install
        sudo tailscaled
    - tailscale: |-
        gp sync-await tailscale-install
        sudo -E tailscale up --authkey ${AUTH_KEY}
- id: gcAdc
  name: "Google Cloud Platform - Application Default Credentials"
  attributes:
    - SERVICE_ACCOUNT, imageLayer
  envVars:
    - name: GOOGLE_APPLICATION_CREDENTIALS
      value: "/home/gitpod/.config/gcloud/application_default_credentials.json"
  tasks:
    - gcloudADC: |-
        GCLOUD_ADC_PATH="/home/gitpod/.config/gcloud/application_default_credentials.json"
        if [ ! -f "$GCLOUD_ADC_PATH" ]; then
            mkdir -p $(dirname $GCLOUD_ADC_PATH)
            echo '${SERVICE_ACCOUNT}' > "$GCLOUD_ADC_PATH"
        fi
