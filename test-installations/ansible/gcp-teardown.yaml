# Copyright (c) 2022 Gitpod GmbH. All rights reserved.
# Licensed under the GNU Affero General Public License (AGPL).
# See License-AGPL.txt in the project root for license information.

---
- name: GCloud login
  hosts: localhost
  gather_facts: no
  vars_files:
    - vars/gcp-teardown.yaml
  roles:
    # this is needed for the gcp-ssh-wrapper.sh script
    - gcp-login

- name: Backup to GCP bucket
  hosts:
    - gitpod_node_main
    - instance_gitlab
    - instance_registry
  vars_files:
    - vars/gcp-teardown.yaml
  roles:
    - gcp-bucket-backup

- name: Delete GCP resources
  hosts: localhost
  gather_facts: no
  vars_files:
    - vars/gcp-teardown.yaml
  vars:
    gcp_instance_names:
      - "{{ gitlab_instance_name }}"
      - "{{ registry_instance_name }}"
      - bastion
  roles:
    - gcp-teardown
