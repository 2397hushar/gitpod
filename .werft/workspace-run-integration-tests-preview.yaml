#
# During development side-load the bash script:
#
#  werft job run github -j .werft/workspace-run-integration-tests.yaml -s .werft/workspace-run-integration-tests.sh
#
pod:
  serviceAccount: werft
  nodeSelector:
    dev/workload: builds
  imagePullSecrets:
    - name: eu-gcr-io-pull-secret
  volumes:
    - name: gcp-sa
      secret:
        secretName: gcp-sa-gitpod-dev-deployer
    - name: config
      emptyDir: {}
    - name: github-token-gitpod-bot
      secret:
        defaultMode: 420
        secretName: github-token-gitpod-bot
    - name: go-build-cache
      hostPath:
        path: /mnt/disks/ssd0/go-build-cache
        type: DirectoryOrCreate
    - name: monitoring-satellite-preview-token
      secret:
        secretName: monitoring-satellite-preview-token
    - name: monitoring-satellite-stackdriver-credentials
      secret:
        secretName: monitoring-satellite-stackdriver-credentials
    - name: prometheus-remote-write-auth
      secret:
        secretName: prometheus-remote-write-auth
    - name: gpsh-harvester-license
      secret:
        secretName: gpsh-harvester-license
    - name: payment-provider-secret
      secret:
        secretName: payment-provider-secret
    - name: go-build-cache
      hostPath:
        path: /mnt/disks/ssd0/go-build-cache
        type: DirectoryOrCreate
    - name: harvester-kubeconfig
      secret:
        secretName: harvester-kubeconfig
    - name: harvester-vm-ssh-keys
      secret:
        secretName: harvester-vm-ssh-keys
    - name: harvester-k3s-dockerhub-pull-account
      secret:
        secretName: harvester-k3s-dockerhub-pull-account
  containers:
    - name: gcloud
      image: eu.gcr.io/gitpod-core-dev/dev/dev-environment:aledbf-dl.1
      workingDir: /workspace
      imagePullPolicy: IfNotPresent
      env:
        - name: GITHUB_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-sh-release-token
              key: token
        - name: GOPROXY
          value: http://athens-athens-proxy.athens.svc.cluster.local:9999
        - name: GOCACHE
          value: /go-build-cache
        - name: NODENAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: NPM_AUTH_TOKEN
          valueFrom:
            secretKeyRef:
              name: npm-auth-token
              key: npm-auth-token.json

        - name: NODENAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: ROBOQUAT_TOKEN
          valueFrom:
            secretKeyRef:
              name: github-roboquat-automatic-changelog
              key: token
        - name: SLACK_NOTIFICATION_PATH
          valueFrom:
            secretKeyRef:
              name: slack-webhook-urls
              key: workspace_jobs
        - name: USERNAME
          valueFrom:
            secretKeyRef:
              name: integration-test-user
              key: username
        - name: USER_TOKEN
          valueFrom:
            secretKeyRef:
              name: integration-test-user
              key: token
        # Used by the Werft CLI through werft-credential-helper.sh
        - name: WERFT_GITHUB_TOKEN_PATH
          value: "/mnt/secrets/github-token-gitpod-bot/token"
        - name: WERFT_CREDENTIAL_HELPER
          value: "/workspace/dev/preview/werft-credential-helper.sh"
      volumeMounts:
        - name: gcp-sa
          mountPath: /mnt/secrets/gcp-sa
          readOnly: true
        - name: config
          mountPath: /config
          readOnly: false
        - mountPath: /mnt/secrets/github-token-gitpod-bot
          name: github-token-gitpod-bot
        - name: go-build-cache
          mountPath: /go-build-cache
          readOnly: false
        - name: monitoring-satellite-stackdriver-credentials
          mountPath: /mnt/secrets/monitoring-satellite-stackdriver-credentials
        - name: monitoring-satellite-preview-token
          mountPath: /mnt/secrets/monitoring-satellite-preview-token
        - name: gpsh-harvester-license
          mountPath: /mnt/secrets/gpsh-harvester
          readOnly: true
        - name: go-build-cache
          mountPath: /go-build-cache
          readOnly: false
        - name: harvester-kubeconfig
          mountPath: /mnt/secrets/harvester-kubeconfig
        - name: harvester-vm-ssh-keys
          mountPath: /mnt/secrets/harvester-vm-ssh-keys
        - name: harvester-k3s-dockerhub-pull-account
          mountPath: /mnt/secrets/harvester-k3s-dockerhub-pull-account
      command:
        - bash
        - -c
        - |
          sleep 1
          set -Eeuo pipefail

          sudo chown gitpod:gitpod $GOCACHE
          export GITHUB_TOKEN=$(echo $GITHUB_TOKEN | xargs)

          export DOCKER_HOST=tcp://$NODENAME:2375
          sudo chown -R gitpod:gitpod /workspace

          mkdir /workspace/.ssh

          (cd .werft && yarn install && mv node_modules ..) | werft log slice prep
          printf '{{ toJson . }}' > context.json

          npx ts-node .werft/build.ts

          ./workspace-run-integration-tests-preview.sh "{{ .Name }}" "{{ .Repository.Repo }}"
plugins:
  cron: "@midnight"
