# debug using `werft run github -f -j .werft/changelog.yaml -a debug=true`
pod:
  serviceAccount: werft
  nodeSelector:
    cloud.google.com/gke-nodepool: builds
  containers:
  - name: build
    image: eu.gcr.io/gitpod-core-dev/dev/dev-environment:aledbf-deve.7
    workingDir: /workspace
    imagePullPolicy: Always
    env:
    - name: LEEWAY_WORKSPACE_ROOT
      value: /workspace
    - name: LEEWAY_REMOTE_CACHE_BUCKET
      value: gitpod-core-leeway-cache-master
    - name: GITHUB_USER
      value: roboquat
    - name: GITHUB_EMAIL
      value: roboquat@gitpod.io
    - name: GITHUB_TOKEN
      valueFrom:
        secretKeyRef:
          name: github-sh-release-token
          key: token
    command:
      - bash
      - -c
      - |
        sleep 1
        set -Eeuo pipefail

        export GITHUB_TOKEN=$(echo $GITHUB_TOKEN | xargs)
        export GIT_REF={{ .Repository.Ref }}
        export GIT_BRANCH=${GIT_REF/refs\/heads\//}
        export GITHUB_ORG={{ .Repository.Owner }}
        export GITHUB_REPO={{ .Repository.Repo }}

        sudo chown -R gitpod:gitpod /workspace
        git checkout $GIT_BRANCH
        leeway run dev/changelog:update
        if [[ $(git status --porcelain) ]]; then
          git config --global user.name $GITHUB_USER
          git config --global user.email $GITHUB_EMAIL
          git config --global credential.helper '/bin/sh -c "echo username=$GITHUB_USER; echo password=$GITHUB_TOKEN"'
          git add CHANGELOG.md
          git commit -m "[changelog] updated changelog"
          git push origin $GIT_BRANCH
        fi
