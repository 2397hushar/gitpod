# debug using `werft run github -f -s .werft/installer-tests.ts -j .werft/k3s-installer-tests.yaml -a debug=true`
args:
- name: image
  desc: "Docker image to build the release from."
  required: true
- name: tag
  desc: "tag to create."
  required: true
pod:
  serviceAccount: werft
  restartPolicy: Never
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: dev/workload
                operator: In
                values:
                  - "builds"
  securityContext:
    runAsUser: 0
  containers:
  - name: nightly-test
    image: eu.gcr.io/gitpod-core-dev/dev/dev-environment:af-dev-update-image.8
    workingDir: /workspace
    imagePullPolicy: Always
    env:
      - name: NODENAME
        valueFrom:
          fieldRef:
            fieldPath: spec.nodeName
      - name: ROBOQUAT_TOKEN
        valueFrom:
          secretKeyRef:
            name: github-roboquat-automatic-changelog
            key: token
    command:
      - bash
      - -c
      - |
        sleep 1
        set -Eeuo pipefail

        sudo chown -R gitpod:gitpod /workspace

        export tag="{{ .Annotations.tag }}"
        export image="{{ .Annotations.image }}"

        if [[ "$tag" == "<no value>" ]] || [[ "$image" == "<no value>" ]]; then
          echo "No tag or image provided, cannot continue";
          exit 1;
        fi

        export REF_NAME="{{ .Repository.Ref }}"

        BRANCH=${REF_NAME#refs/heads/}

        git checkout $BRANCH

        git config --global user.name roboquat
        git config --global user.email roboquat@gitpod.io
        git remote set-url origin https://oauth2:$ROBOQUAT_TOKEN@github.com/gitpod-io/gitpod.git

        # git tag $tag
        # git push origin $tag

        bash install/installer/scripts/create-release-note.sh $image $tag

        cat release-note-$tag.md

        cd install/installer
        VERSION=$image make
        cd ../..

        # gh release create $tag --notes-file release-note-$tag.md --draft --prerelease install/installer/dist
        # replicated promote
